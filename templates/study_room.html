{% extends 'base.html' %}
{% block content %}
<div class="dashboard-grid">
    <div class="card" style="grid-column: span 2;">
        <h2>Study Room: <span class="text-accent">{{ room.room_code }}</span></h2>

        <div class="room-status" style="margin-bottom: 2rem;">
            <div style="display: flex; gap: 1rem; align-items: center;">
                <div class="user-badge"
                    style="padding: 0.5rem 1rem; background: var(--surface-hover); border-radius: 20px;">
                    ðŸ‘¤ You: {{ user.username }}
                </div>
                <div class="user-badge"
                    style="padding: 0.5rem 1rem; background: var(--surface-hover); border-radius: 20px;">
                    ðŸ‘¥ Partner:
                    <span id="partner-status">
                        {% if room.partner %}
                        {{ room.partner.username }}
                        {% else %}
                        Waiting for partner...
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>

        <!-- Timer Duration Configuration -->
        <div style="text-align: center; margin-bottom: 2rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Study Duration
                (minutes):</label>
            <input type="number" id="study-duration" value="25" min="1" max="180"
                style="width: 100px; padding: 0.5rem; border-radius: 8px; border: 1px solid var(--surface-hover); background: var(--surface-color); color: var(--text-primary); text-align: center; font-size: 1.2rem;">
        </div>

        <div class="pomodoro-timer" style="text-align: center; margin: 3rem 0;">
            <div id="timer-display" style="font-size: 5rem; font-weight: bold; font-family: monospace;">
                25:00
            </div>
            <div id="timer-phase" class="text-secondary" style="margin-bottom: 2rem;">
                Ready to Study
            </div>

            <div class="controls" style="display: flex; gap: 1rem; justify-content: center;">
                <button id="btn-start" class="btn btn-secondary" onclick="startSession()">Start Session</button>
                <button id="btn-pause" class="btn btn-warning" style="display: none;"
                    onclick="permAction('pause')">Pause</button>
                <button id="btn-resume" class="btn btn-secondary" style="display: none;"
                    onclick="permAction('resume')">Resume</button>
                <button id="btn-stop" class="btn btn-danger" style="display: none;"
                    onclick="permAction('stop')">Stop</button>
            </div>
        </div>

    </div>
</div>

<script>
    const ROOM_CODE = "{{ room.room_code }}";
    const IS_CREATOR = {{ is_creator|yesno:"true,false" }};
    const CSRF_TOKEN = "{{ csrf_token }}";

    console.log("Study Room Initialized:");
    console.log("Room Code:", ROOM_CODE);
    console.log("Is Creator:", IS_CREATOR);
    console.log("CSRF Token:", CSRF_TOKEN ? "Present" : "Missing");

    // State
    let currentState = {
        status: 'stopped',
        phase: 'study',
        elapsed: 0,
        partner_joined: false
    };

    // Config - Will be updated based on user input
    let PHASE_DURATION = {
        'study': 25 * 60,
        'short_break': 5 * 60,
        'long_break': 15 * 60
    };

    // Update timer display when user changes duration
    document.getElementById('study-duration').addEventListener('input', function (e) {
        const minutes = parseInt(e.target.value) || 25;
        PHASE_DURATION['study'] = minutes * 60;
        console.log("Duration updated to:", minutes, "minutes");
        if (currentState.status === 'stopped') {
            updateDisplay(PHASE_DURATION['study'], 'study');
        }
    });

    function updateDisplay(secondsRemaining, phase) {
        if (secondsRemaining < 0) secondsRemaining = 0;

        const m = Math.floor(secondsRemaining / 60);
        const s = Math.floor(secondsRemaining % 60);
        document.getElementById('timer-display').textContent =
            `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

        const phaseNames = {
            'study': 'Focus Time',
            'short_break': 'Short Break',
            'long_break': 'Long Break'
        };
        document.getElementById('timer-phase').textContent = phaseNames[phase] || phase;
    }

    function updateControls(status) {
        const btnStart = document.getElementById('btn-start');
        const btnPause = document.getElementById('btn-pause');
        const btnResume = document.getElementById('btn-resume');
        const btnStop = document.getElementById('btn-stop');
        const durationInput = document.getElementById('study-duration');

        // Hide all first
        [btnStart, btnPause, btnResume, btnStop].forEach(b => b.style.display = 'none');

        if (status === 'stopped') {
            btnStart.style.display = 'inline-block';
            durationInput.disabled = false;
        } else {
            durationInput.disabled = true;
            if (status === 'running') {
                btnPause.style.display = 'inline-block';
                btnStop.style.display = 'inline-block';
            } else if (status === 'paused') {
                btnResume.style.display = 'inline-block';
                btnStop.style.display = 'inline-block';
            }
        }
    }

    async function tick() {
        try {
            const resp = await fetch(`/api/room/${ROOM_CODE}/sync/`);
            if (!resp.ok) {
                console.warn("Sync failed with status:", resp.status);
                return;
            }

            const data = await resp.json();
            currentState = data;

            // Update Partner Text
            const pStatus = document.getElementById('partner-status');
            if (data.partner_joined && data.partner_name) {
                pStatus.textContent = data.partner_name;
            } else if (!data.partner_joined) {
                pStatus.textContent = "Waiting for partner...";
            }

            // Sync Duration from Server if available (only when timer is active or partner joined)
            if (data.timer_duration && (data.status !== 'stopped' || data.partner_joined)) {
                const serverDuration = data.timer_duration * 60;
                if (PHASE_DURATION['study'] !== serverDuration) {
                    PHASE_DURATION['study'] = serverDuration;
                    document.getElementById('study-duration').value = data.timer_duration;
                }
            }

            // Calc Time
            let duration = PHASE_DURATION[data.phase];
            let remaining = duration - data.elapsed_seconds;

            // Auto-complete logic
            if (remaining <= 0 && data.status === 'running' && IS_CREATOR) {
                console.log("Timer completed, triggering completion");
                await sendAction('complete');
            }

            updateDisplay(remaining, data.phase);
            updateControls(data.status);

        } catch (e) {
            console.error("Sync error:", e);
        }
    }

    async function sendAction(action, extraData = {}) {
        console.log("Sending action:", action, "with data:", extraData);
        try {
            const payload = {
                action: action,
                room_code: ROOM_CODE,
                ...extraData
            };

            console.log("POST to /api/pomodoro/ with payload:", payload);

            const resp = await fetch('/api/pomodoro/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify(payload)
            });

            console.log("Response status:", resp.status);

            if (!resp.ok) {
                const text = await resp.text();
                console.error('Action failed. Status:', resp.status, 'Response:', text);
                alert("Action failed: " + text);
            } else {
                const result = await resp.json();
                console.log("Action success:", result);
            }

            await tick(); // Immediate update
        } catch (e) {
            console.error("Action failed:", e);
            alert("Action failed: " + e.message);
        }
    }

    // Wrapper for start button
    window.startSession = function () {
        console.log("startSession() called");
        const duration = parseInt(document.getElementById('study-duration').value) || 25;
        console.log("Starting session with duration:", duration, "minutes");
        PHASE_DURATION['study'] = duration * 60;
        sendAction('start', { phase: 'study', duration: duration });
    }

    // Wrapper for other button clicks
    window.permAction = function (action) {
        console.log("permAction() called with:", action);
        sendAction(action);
    }

    // Poll every 1s
    setInterval(tick, 1000);
    tick(); // Initial call

    console.log("Study room script loaded successfully");

</script>
{% endblock %}